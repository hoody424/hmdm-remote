Janus.sessions={},Janus.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),n=33;return window.navigator.userAgent.match("Linux")&&(n=35),e>=26&&e<=n||Janus.extension.isInstalled()}return!0};var defaultExtension={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var n=window.setTimeout((function(){var n=new Error("NavigatorUserMediaError");return n.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(n)}),1e3);this.cache[n]=e,window.postMessage({type:"janusGetScreen",id:n},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",(function(n){if(n.origin==window.location.origin)if("janusGotScreen"==n.data.type&&e[n.data.id]){var t=e[n.data.id];if(delete e[n.data.id],""===n.data.sourceId){var r=new Error("NavigatorUserMediaError");r.name="You cancelled the request for permission, giving up...",t(r)}else t(null,n.data.sourceId)}else"janusGetScreenPending"==n.data.type&&(console.log("clearing ",n.data.id),window.clearTimeout(n.data.id))}))}};function Janus(e){if((e=e||{}).success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:Janus.noop,!Janus.initDone)return e.error("Library not initialized"),{};if(!Janus.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(Janus.log("Library initialized: "+Janus.initDone),!e.server)return e.error("Invalid server url"),{};var n=!1,t=null,r={},o=null,a=null,s=0,i=e.server;Janus.isArray(i)?(Janus.log("Multiple servers provided ("+i.length+"), will use the first that works"),i=null,a=e.server,Janus.debug(a)):0===i.indexOf("ws")?(n=!0,Janus.log("Using WebSockets to contact Janus: "+i)):(n=!1,Janus.log("Using REST API to contact Janus: "+i));var d=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],c=e.iceTransportPolicy,u=e.bundlePolicy,l=!0===e.ipv6,f=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(f=!0===e.withCredentials);var m=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(m=e.max_poll_events),m<1&&(m=1);var g=null;void 0!==e.token&&null!==e.token&&(g=e.token);var h=null;void 0!==e.apisecret&&null!==e.apisecret&&(h=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var p=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(p=e.keepAlivePeriod),isNaN(p)&&(p=25e3);var v=6e4;function b(e){var n={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(n.high=e.high),e.medium&&(n.medium=e.medium),e.low&&(n.low=e.low)),n}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(v=e.longPollTimeout),isNaN(v)&&(v=6e4);var w=!1,J=null,S={},y=this,k=0,C={};function T(){if(null!=J)if(Janus.debug("Long poll..."),w){var n=i+"/"+J+"?rid="+(new Date).getTime();m&&(n=n+"&maxev="+m),g&&(n=n+"&token="+encodeURIComponent(g)),h&&(n=n+"&apisecret="+encodeURIComponent(h)),Janus.httpAPICall(n,{verb:"GET",withCredentials:f,success:D,timeout:v,error:function(n,t){if(Janus.error(n+":",t),++k>3)return w=!1,void e.error("Lost connection to the server (is it down?)");T()}})}else Janus.warn("Is the server down? (connected=false)")}function D(e,r){if(k=0,n||null==J||!0===r||T(),n||!Janus.isArray(e))if("keepalive"!==e.janus)if("server_info"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){if(!(d=e.sender))return void Janus.warn("Missing sender...");if(!(u=S[d]))return void Janus.debug("This handle is not attached to this session");var o=e.candidate;Janus.debug("Got a trickled candidate on session "+J),Janus.debug(o);var a=u.webrtcStuff;a.pc&&a.remoteSdp?(Janus.debug("Adding remote candidate:",o),o&&!0!==o.completed?a.pc.addIceCandidate(o):a.pc.addIceCandidate(Janus.endOfCandidates)):(Janus.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),a.candidates||(a.candidates=[]),a.candidates.push(o),Janus.debug(a.candidates))}else{if("webrtcup"===e.janus)return Janus.debug("Got a webrtcup event on session "+J),Janus.debug(e),(d=e.sender)?(u=S[d])?void u.webrtcState(!0):void Janus.debug("This handle is not attached to this session"):void Janus.warn("Missing sender...");if("hangup"===e.janus){if(Janus.debug("Got a hangup event on session "+J),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");if(!(u=S[d]))return void Janus.debug("This handle is not attached to this session");u.webrtcState(!1,e.reason),u.hangup()}else if("detached"===e.janus){if(Janus.debug("Got a detached event on session "+J),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");if(!(u=S[d]))return;u.detached=!0,u.ondetached(),u.detach()}else if("media"===e.janus){if(Janus.debug("Got a media event on session "+J),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");if(!(u=S[d]))return void Janus.debug("This handle is not attached to this session");u.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){if(Janus.debug("Got a slowlink event on session "+J),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");if(!(u=S[d]))return void Janus.debug("This handle is not attached to this session");u.slowLink(e.uplink,e.lost)}else{if("error"===e.janus){var s,i;if(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),Janus.debug(e),s=e.transaction)(i=C[s])&&i(e),delete C[s];return}if("event"===e.janus){var d;if(Janus.debug("Got a plugin event on session "+J),Janus.debug(e),!(d=e.sender))return void Janus.warn("Missing sender...");var c=e.plugindata;if(!c)return void Janus.warn("Missing plugindata...");Janus.debug("  -- Event is coming from "+d+" ("+c.plugin+")");var u,l=c.data;if(Janus.debug(l),!(u=S[d]))return void Janus.warn("This handle is not attached to this session");var f=e.jsep;f&&(Janus.debug("Handling SDP as well..."),Janus.debug(f));var m=u.onmessage;m?(Janus.debug("Notifying application..."),m(l,f)):Janus.debug("No provided notification callback")}else{if("timeout"===e.janus)return Janus.error("Timeout on session "+J),Janus.debug(e),void(n&&t.close(3504,"Gateway timeout"));Janus.warn("Unknown message/event  '"+e.janus+"' on session "+J),Janus.debug(e)}}}else Janus.debug("Got a success on session "+J),Janus.debug(e),(s=e.transaction)&&((i=C[s])&&i(e),delete C[s]);else Janus.debug("Got an ack on session "+J),Janus.debug(e),(s=e.transaction)&&((i=C[s])&&i(e),delete C[s]);else Janus.debug("Got info on the Janus instance"),Janus.debug(e),(s=e.transaction)&&((i=C[s])&&i(e),delete C[s]);else Janus.vdebug("Got a keepalive on session "+J);else for(var g=0;g<e.length;g++)D(e[g],!0)}function R(){if(i&&n&&w){o=setTimeout(R,p);var e={janus:"keepalive",session_id:J,transaction:Janus.randomString(12)};g&&(e.token=g),h&&(e.apisecret=h),t.send(JSON.stringify(e))}}function I(d){var c=Janus.randomString(12),u={janus:"create",transaction:c};if(d.reconnect&&(w=!1,u.janus="claim",u.session_id=J,t&&(t.onopen=null,t.onerror=null,t.onclose=null,o&&(clearTimeout(o),o=null))),g&&(u.token=g),h&&(u.apisecret=h),!i&&Janus.isArray(a)&&(0===(i=a[s]).indexOf("ws")?(n=!0,Janus.log("Server #"+(s+1)+": trying WebSockets to contact Janus ("+i+")")):(n=!1,Janus.log("Server #"+(s+1)+": trying REST API to contact Janus ("+i+")"))),n)for(var l in t=Janus.newWebSocket(i,"janus-protocol"),r={error:function(){if(Janus.error("Error connecting to the Janus WebSockets server... "+i),Janus.isArray(a)&&!d.reconnect)return++s===a.length?void d.error("Error connecting to any of the provided Janus servers: Is the server down?"):(i=null,void setTimeout((function(){I(d)}),200));d.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){C[c]=function(e){if(Janus.debug(e),"success"!==e.janus)return Janus.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);o=setTimeout(R,p),w=!0,J=e.session_id?e.session_id:e.data.id,d.reconnect?Janus.log("Claimed session: "+J):Janus.log("Created session: "+J),Janus.sessions[J]=y,d.success()},t.send(JSON.stringify(u))},message:function(e){D(JSON.parse(e.data))},close:function(){i&&w&&(w=!1,e.error("Lost connection to the server (is it down?)"))}})t.addEventListener(l,r[l]);else Janus.httpAPICall(i,{verb:"POST",withCredentials:f,body:u,success:function(e){if(Janus.debug(e),"success"!==e.janus)return Janus.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);w=!0,J=e.session_id?e.session_id:e.data.id,d.reconnect?Janus.log("Claimed session: "+J):Janus.log("Created session: "+J),Janus.sessions[J]=y,T(),d.success()},error:function(e,n){if(Janus.error(e+":",n),Janus.isArray(a)&&!d.reconnect)return++s===a.length?void d.error("Error connecting to any of the provided Janus servers: Is the server down?"):(i=null,void setTimeout((function(){I(d)}),200));""===n?d.error(e+": Is the server down?"):d.error(e+": "+n)}})}function A(e,r){if((r=r||{}).success="function"==typeof r.success?r.success:Janus.noop,r.error="function"==typeof r.error?r.error:Janus.noop,!w)return Janus.warn("Is the server down? (connected=false)"),void r.error("Is the server down? (connected=false)");var o=S[e];if(!o||!o.webrtcStuff)return Janus.warn("Invalid handle"),void r.error("Invalid handle");var a=r.message,s=r.jsep,d=Janus.randomString(12),c={janus:"message",body:a,transaction:d};if(o.token&&(c.token=o.token),h&&(c.apisecret=h),s&&(c.jsep={type:s.type,sdp:s.sdp},s.e2ee&&(c.jsep.e2ee=!0),"hml"!==s.rid_order&&"lmh"!==s.rid_order||(c.jsep.rid_order=s.rid_order)),Janus.debug("Sending message to plugin (handle="+e+"):"),Janus.debug(c),n)return c.session_id=J,c.handle_id=e,C[d]=function(e){if(Janus.debug("Message sent!"),Janus.debug(e),"success"===e.janus){var n=e.plugindata;if(!n)return Janus.warn("Request succeeded, but missing plugindata..."),void r.success();Janus.log("Synchronous transaction successful ("+n.plugin+")");var t=n.data;return Janus.debug(t),void r.success(t)}"ack"===e.janus?r.success():e.error?(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),r.error(e.error.code+" "+e.error.reason)):(Janus.error("Unknown error"),r.error("Unknown error"))},void t.send(JSON.stringify(c));Janus.httpAPICall(i+"/"+J+"/"+e,{verb:"POST",withCredentials:f,body:c,success:function(e){if(Janus.debug("Message sent!"),Janus.debug(e),"success"===e.janus){var n=e.plugindata;if(!n)return Janus.warn("Request succeeded, but missing plugindata..."),void r.success();Janus.log("Synchronous transaction successful ("+n.plugin+")");var t=n.data;return Janus.debug(t),void r.success(t)}"ack"===e.janus?r.success():e.error?(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),r.error(e.error.code+" "+e.error.reason)):(Janus.error("Unknown error"),r.error("Unknown error"))},error:function(e,n){Janus.error(e+":",n),r.error(e+": "+n)}})}function x(e,r){if(w){var o=S[e];if(o&&o.webrtcStuff){var a={janus:"trickle",candidate:r,transaction:Janus.randomString(12)};if(o.token&&(a.token=o.token),h&&(a.apisecret=h),Janus.vdebug("Sending trickle candidate (handle="+e+"):"),Janus.vdebug(a),n)return a.session_id=J,a.handle_id=e,void t.send(JSON.stringify(a));Janus.httpAPICall(i+"/"+J+"/"+e,{verb:"POST",withCredentials:f,body:a,success:function(e){Janus.vdebug("Candidate sent!"),Janus.vdebug(e),"ack"===e.janus||Janus.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,n){Janus.error(e+":",n)}})}else Janus.warn("Invalid handle")}else Janus.warn("Is the server down? (connected=false)")}function P(e,n,t,r,o){var a=S[e];if(a&&a.webrtcStuff){var s=a.webrtcStuff;if(s.pc){var i=function(e){Janus.log("Received state change on data channel:",e);var n=e.target.label,t=e.target.protocol,r=s.dataChannel[n]?s.dataChannel[n].readyState:"null";if(Janus.log("State change on <"+n+"> data channel: "+r),"open"===r){if(s.dataChannel[n].pending&&s.dataChannel[n].pending.length>0){for(var o of(Janus.log("Sending pending messages on <"+n+">:",s.dataChannel[n].pending.length),s.dataChannel[n].pending))Janus.log("Sending data on data channel <"+n+">"),Janus.debug(o),s.dataChannel[n].send(o);s.dataChannel[n].pending=[]}a.ondataopen(n,t)}};if(r)s.dataChannel[n]=r;else{var d={ordered:!0};t&&(d.protocol=t),s.dataChannel[n]=s.pc.createDataChannel(n,d)}s.dataChannel[n].onmessage=function(e){Janus.log("Received message on data channel:",e);var n=e.target.label;a.ondata(e.data,n)},s.dataChannel[n].onopen=i,s.dataChannel[n].onclose=i,s.dataChannel[n].onerror=function(e){Janus.error("Got error on data channel:",e)},s.dataChannel[n].pending=[],o&&s.dataChannel[n].pending.push(o)}else Janus.warn("Invalid PeerConnection")}else Janus.warn("Invalid handle")}function E(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var t=S[e];if(!t||!t.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var r=t.webrtcStuff,o=n.text||n.data;if(!o)return Janus.warn("Invalid data"),void n.error("Invalid data");var a=n.label?n.label:Janus.dataChanDefaultLabel;return r.dataChannel[a]?"open"!==r.dataChannel[a].readyState?(r.dataChannel[a].pending.push(o),void n.success()):(Janus.log("Sending data on data channel <"+a+">"),Janus.debug(o),r.dataChannel[a].send(o),void n.success()):(P(e,a,n.protocol,!1,o,n.protocol),void n.success())}function M(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var t=S[e];if(!t||!t.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var r=t.webrtcStuff;if(!r.dtmfSender){if(r.pc){var o=r.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!o)return Janus.warn("Invalid DTMF configuration (no audio track)"),void n.error("Invalid DTMF configuration (no audio track)");r.dtmfSender=o.dtmf,r.dtmfSender&&(Janus.log("Created DTMF Sender"),r.dtmfSender.ontonechange=function(e){Janus.debug("Sent DTMF tone: "+e.tone)})}if(!r.dtmfSender)return Janus.warn("Invalid DTMF configuration"),void n.error("Invalid DTMF configuration")}var a=n.dtmf;if(!a)return Janus.warn("Invalid DTMF parameters"),void n.error("Invalid DTMF parameters");var s=a.tones;if(!s)return Janus.warn("Invalid DTMF string"),void n.error("Invalid DTMF string");var i="number"==typeof a.duration?a.duration:500,d="number"==typeof a.gap?a.gap:50;Janus.debug("Sending DTMF string "+s+" (duration "+i+"ms, gap "+d+"ms)"),r.dtmfSender.insertDTMF(s,i,d),n.success()}function V(e,r){(r=r||{}).success="function"==typeof r.success?r.success:Janus.noop,r.error="function"==typeof r.error?r.error:Janus.noop;var o=!0===r.noRequest;Janus.log("Destroying handle "+e+" (only-locally="+o+")"),W(e);var a=S[e];if(!a||a.detached)return delete S[e],void r.success();if(o)return delete S[e],void r.success();if(!w)return Janus.warn("Is the server down? (connected=false)"),void r.error("Is the server down? (connected=false)");var s={janus:"detach",transaction:Janus.randomString(12)};if(a.token&&(s.token=a.token),h&&(s.apisecret=h),n)return s.session_id=J,s.handle_id=e,t.send(JSON.stringify(s)),delete S[e],void r.success();Janus.httpAPICall(i+"/"+J+"/"+e,{verb:"POST",withCredentials:f,body:s,success:function(n){Janus.log("Destroyed handle:"),Janus.debug(n),"success"!==n.janus&&Janus.error("Ooops: "+n.error.code+" "+n.error.reason),delete S[e],r.success()},error:function(n,t){Janus.error(n+":",t),delete S[e],r.success()}})}function j(e,n,t,r,o){var a=S[e];if(!a||!a.webrtcStuff)return Janus.warn("Invalid handle"),r.stream||Janus.stopAllTracks(o),void r.error("Invalid handle");var s=a.webrtcStuff;Janus.debug("streamsDone:",o),o&&(Janus.debug("  -- Audio tracks:",o.getAudioTracks()),Janus.debug("  -- Video tracks:",o.getVideoTracks()));var i=!1;if(s.myStream&&t.update&&!s.streamExternal){if((!t.update&&B(t)||t.update&&(t.addAudio||t.replaceAudio))&&o.getAudioTracks()&&o.getAudioTracks().length)if(s.myStream.addTrack(o.getAudioTracks()[0]),Janus.unifiedPlan){Janus.log((t.replaceAudio?"Replacing":"Adding")+" audio track:",o.getAudioTracks()[0]);var f=null;if((g=s.pc.getTransceivers())&&g.length>0)for(var m of g)if(m.sender&&m.sender.track&&"audio"===m.sender.track.kind||m.receiver&&m.receiver.track&&"audio"===m.receiver.track.kind){f=m;break}f&&f.sender?f.sender.replaceTrack(o.getAudioTracks()[0]):s.pc.addTrack(o.getAudioTracks()[0],o)}else Janus.log((t.replaceAudio?"Replacing":"Adding")+" audio track:",o.getAudioTracks()[0]),s.pc.addTrack(o.getAudioTracks()[0],o);if((!t.update&&q(t)||t.update&&(t.addVideo||t.replaceVideo))&&o.getVideoTracks()&&o.getVideoTracks().length)if(s.myStream.addTrack(o.getVideoTracks()[0]),Janus.unifiedPlan){Janus.log((t.replaceVideo?"Replacing":"Adding")+" video track:",o.getVideoTracks()[0]);var g,h=null;if((g=s.pc.getTransceivers())&&g.length>0)for(var m of g)if(m.sender&&m.sender.track&&"video"===m.sender.track.kind||m.receiver&&m.receiver.track&&"video"===m.receiver.track.kind){h=m;break}h&&h.sender?h.sender.replaceTrack(o.getVideoTracks()[0]):s.pc.addTrack(o.getVideoTracks()[0],o)}else Janus.log((t.replaceVideo?"Replacing":"Adding")+" video track:",o.getVideoTracks()[0]),s.pc.addTrack(o.getVideoTracks()[0],o)}else s.myStream=o,i=!0;if(!s.pc){var p={iceServers:d,iceTransportPolicy:c,bundlePolicy:u};"chrome"===Janus.webRTCAdapter.browserDetails.browser&&(p.sdpSemantics=Janus.webRTCAdapter.browserDetails.version<72?"plan-b":"unified-plan");var v={optional:[{DtlsSrtpKeyAgreement:!0}]};if(l&&v.optional.push({googIPv6:!0}),r.rtcConstraints&&"object"==typeof r.rtcConstraints)for(var w in Janus.debug("Adding custom PeerConnection constraints:",r.rtcConstraints),r.rtcConstraints)v.optional.push(r.rtcConstraints[w]);"edge"===Janus.webRTCAdapter.browserDetails.browser&&(p.bundlePolicy="max-bundle"),RTCRtpSender&&(RTCRtpSender.prototype.createEncodedStreams||RTCRtpSender.prototype.createEncodedAudioStreams&&RTCRtpSender.prototype.createEncodedVideoStreams)&&(r.senderTransforms||r.receiverTransforms)&&(s.senderTransforms=r.senderTransforms,s.receiverTransforms=r.receiverTransforms,p.forceEncodedAudioInsertableStreams=!0,p.forceEncodedVideoInsertableStreams=!0,p.encodedInsertableStreams=!0),Janus.log("Creating PeerConnection"),Janus.debug(v),s.pc=new RTCPeerConnection(p,v),Janus.debug(s.pc),s.pc.getStats&&(s.volume={},s.bitrate.value="0 kbits/sec"),Janus.log("Preparing local SDP and gathering candidates (trickle="+s.trickle+")"),s.pc.oniceconnectionstatechange=function(e){s.pc&&a.iceState(s.pc.iceConnectionState)},s.pc.onicecandidate=function(n){if(!n.candidate||"edge"===Janus.webRTCAdapter.browserDetails.browser&&n.candidate.candidate.indexOf("endOfCandidates")>0)Janus.log("End of candidates."),s.iceDone=!0,!0===s.trickle?x(e,{completed:!0}):function(e,n){n=n||{},n.success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var t=S[e];if(!t||!t.webrtcStuff)return void Janus.warn("Invalid handle, not sending anything");var r=t.webrtcStuff;if(Janus.log("Sending offer/answer SDP..."),!r.mySdp)return void Janus.warn("Local SDP instance is invalid, not sending anything...");r.mySdp={type:r.pc.localDescription.type,sdp:r.pc.localDescription.sdp},!1===r.trickle&&(r.mySdp.trickle=!1);Janus.debug(n),r.sdpSent=!0,n.success(r.mySdp)}(e,r);else{var t={candidate:n.candidate.candidate,sdpMid:n.candidate.sdpMid,sdpMLineIndex:n.candidate.sdpMLineIndex};!0===s.trickle&&x(e,t)}},s.pc.ontrack=function(e){if(Janus.log("Handling Remote Track"),Janus.debug(e),e.streams&&(s.remoteStream=e.streams[0],a.onremotestream(s.remoteStream),!e.track.onended)){if(s.receiverTransforms){var n=null;RTCRtpSender.prototype.createEncodedStreams?n=e.receiver.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===e.track.kind&&s.receiverTransforms.audio?n=e.receiver.createEncodedAudioStreams():"video"===e.track.kind&&s.receiverTransforms.video&&(n=e.receiver.createEncodedVideoStreams())),n&&(console.log(n),n.readableStream&&n.writableStream?n.readableStream.pipeThrough(s.receiverTransforms[e.track.kind]).pipeTo(n.writableStream):n.readable&&n.writable&&n.readable.pipeThrough(s.receiverTransforms[e.track.kind]).pipeTo(n.writable))}var t=null;Janus.log("Adding onended callback to track:",e.track),e.track.onended=function(e){Janus.log("Remote track removed:",e),s.remoteStream&&(clearTimeout(t),s.remoteStream.removeTrack(e.target),a.onremotestream(s.remoteStream))},e.track.onmute=function(e){Janus.log("Remote track muted:",e),s.remoteStream&&null==t&&(t=setTimeout((function(){Janus.log("Removing remote track"),s.remoteStream&&(s.remoteStream.removeTrack(e.target),a.onremotestream(s.remoteStream)),t=null}),2520))},e.track.onunmute=function(e){if(Janus.log("Remote track flowing again:",e),null!=t)clearTimeout(t),t=null;else try{s.remoteStream.addTrack(e.target),a.onremotestream(s.remoteStream)}catch(e){Janus.error(e)}}}}}if(i&&o){Janus.log("Adding local stream");var J=!0===r.simulcast2;o.getTracks().forEach((function(e){Janus.log("Adding local track:",e);var n=null;if(J&&"audio"!==e.kind){Janus.log("Enabling rid-based simulcasting:",e);var t=b(r.simulcastMaxBitrates),a=s.pc.addTransceiver(e,{direction:"sendrecv",streams:[o],sendEncodings:r.sendEncodings||[{rid:"h",active:!0,maxBitrate:t.high},{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:t.low,scaleResolutionDownBy:4}]});a&&(n=a.sender)}else n=s.pc.addTrack(e,o);if(n&&s.senderTransforms){var i=null;RTCRtpSender.prototype.createEncodedStreams?i=n.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===n.track.kind&&s.senderTransforms.audio?i=n.createEncodedAudioStreams():"video"===n.track.kind&&s.senderTransforms.video&&(i=n.createEncodedVideoStreams())),i&&(console.log(i),i.readableStream&&i.writableStream?i.readableStream.pipeThrough(s.senderTransforms[n.track.kind]).pipeTo(i.writableStream):i.readable&&i.writable&&i.readable.pipeThrough(s.senderTransforms[n.track.kind]).pipeTo(i.writable))}}))}(function(e){if(Janus.debug("isDataEnabled:",e),"edge"===Janus.webRTCAdapter.browserDetails.browser)return Janus.warn("Edge doesn't support data channels yet"),!1;return null!=e&&!0===e.data})(t)&&!s.dataChannel[Janus.dataChanDefaultLabel]&&(Janus.log("Creating default data channel"),P(e,Janus.dataChanDefaultLabel,null,!1),s.pc.ondatachannel=function(n){Janus.log("Data channel created by Janus:",n),P(e,n.channel.label,n.channel.protocol,n.channel)}),s.myStream&&a.onlocalstream(s.myStream),n?s.pc.setRemoteDescription(n).then((function(){if(Janus.log("Remote description accepted!"),s.remoteSdp=n.sdp,s.candidates&&s.candidates.length>0){for(var o=0;o<s.candidates.length;o++){var a=s.candidates[o];Janus.debug("Adding remote candidate:",a),a&&!0!==a.completed?s.pc.addIceCandidate(a):s.pc.addIceCandidate(Janus.endOfCandidates)}s.candidates=[]}!function(e,n,t){t=t||{},t.success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:Janus.noop,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:Janus.noop;var r=S[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),void t.error("Invalid handle");var o=r.webrtcStuff,a=!0===t.simulcast;a?Janus.log("Creating answer (iceDone="+o.iceDone+", simulcast="+a+")"):Janus.log("Creating answer (iceDone="+o.iceDone+")");var s=null;if(Janus.unifiedPlan){s={};var i=null,d=null,c=o.pc.getTransceivers();if(c&&c.length>0)for(var u of c)u.sender&&u.sender.track&&"audio"===u.sender.track.kind||u.receiver&&u.receiver.track&&"audio"===u.receiver.track.kind?i||(i=u):(u.sender&&u.sender.track&&"video"===u.sender.track.kind||u.receiver&&u.receiver.track&&"video"===u.receiver.track.kind)&&(d||(d=u));var l=B(n),f=G(n);if(l||f){if(l&&f){if(i)try{i.setDirection?i.setDirection("sendrecv"):i.direction="sendrecv",Janus.log("Setting audio transceiver to sendrecv:",i)}catch(e){Janus.error(e)}}else if(l&&!f)try{i&&(i.setDirection?i.setDirection("sendonly"):i.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",i))}catch(e){Janus.error(e)}else if(!l&&f)if(i)try{i.setDirection?i.setDirection("recvonly"):i.direction="recvonly",Janus.log("Setting audio transceiver to recvonly:",i)}catch(e){Janus.error(e)}else i=o.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",i)}else if(n.removeAudio&&i)try{i.setDirection?i.setDirection("inactive"):i.direction="inactive",Janus.log("Setting audio transceiver to inactive:",i)}catch(e){Janus.error(e)}var m=q(n),g=z(n);if(m||g){if(m&&g){if(d)try{d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",Janus.log("Setting video transceiver to sendrecv:",d)}catch(e){Janus.error(e)}}else if(m&&!g){if(d)try{d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",Janus.log("Setting video transceiver to sendonly:",d)}catch(e){Janus.error(e)}}else if(!m&&g)if(d)try{d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",Janus.log("Setting video transceiver to recvonly:",d)}catch(e){Janus.error(e)}else d=o.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",d)}else if(n.removeVideo&&d)try{d.setDirection?d.setDirection("inactive"):d.direction="inactive",Janus.log("Setting video transceiver to inactive:",d)}catch(e){Janus.error(e)}}else s="firefox"===Janus.webRTCAdapter.browserDetails.browser||"edge"===Janus.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:G(n),offerToReceiveVideo:z(n)}:{mandatory:{OfferToReceiveAudio:G(n),OfferToReceiveVideo:z(n)}};Janus.debug(s);var h=q(n);if(h&&a&&"firefox"===Janus.webRTCAdapter.browserDetails.browser){Janus.log("Enabling Simulcasting for Firefox (RID)");var p=o.pc.getSenders()[1];Janus.log(p);var v=p.getParameters();Janus.log(v);var w=b(t.simulcastMaxBitrates);p.setParameters({encodings:t.sendEncodings||[{rid:"h",active:!0,maxBitrate:w.high},{rid:"m",active:!0,maxBitrate:w.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:w.low,scaleResolutionDownBy:4}]})}o.pc.createAnswer(s).then((function(e){Janus.debug(e);var n={type:e.type,sdp:e.sdp};t.customizeSdp(n),e.sdp=n.sdp,Janus.log("Setting local description"),h&&a&&("chrome"===Janus.webRTCAdapter.browserDetails.browser?Janus.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp={type:"answer",sdp:e.sdp},o.pc.setLocalDescription(e).catch(t.error),o.mediaConstraints=s,o.iceDone||o.trickle?((o.senderTransforms||o.receiverTransforms)&&(e.e2ee=!0),t.success(e)):Janus.log("Waiting for all candidates...")}),t.error)}(e,t,r)}),r.error):function(e,n,t){t=t||{},t.success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:Janus.noop,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:Janus.noop;var r=S[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),void t.error("Invalid handle");var o=r.webrtcStuff,a=!0===t.simulcast;a?Janus.log("Creating offer (iceDone="+o.iceDone+", simulcast="+a+")"):Janus.log("Creating offer (iceDone="+o.iceDone+")");var s={};if(Janus.unifiedPlan){var i=null,d=null,c=o.pc.getTransceivers();if(c&&c.length>0)for(var u of c)u.sender&&u.sender.track&&"audio"===u.sender.track.kind||u.receiver&&u.receiver.track&&"audio"===u.receiver.track.kind?i||(i=u):(u.sender&&u.sender.track&&"video"===u.sender.track.kind||u.receiver&&u.receiver.track&&"video"===u.receiver.track.kind)&&(d||(d=u));var l=B(n),f=G(n);l||f?l&&f?i&&(i.setDirection?i.setDirection("sendrecv"):i.direction="sendrecv",Janus.log("Setting audio transceiver to sendrecv:",i)):l&&!f?i&&(i.setDirection?i.setDirection("sendonly"):i.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",i)):!l&&f&&(i?(i.setDirection?i.setDirection("recvonly"):i.direction="recvonly",Janus.log("Setting audio transceiver to recvonly:",i)):(i=o.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",i))):n.removeAudio&&i&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive",Janus.log("Setting audio transceiver to inactive:",i));var m=q(n),g=z(n);m||g?m&&g?d&&(d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",Janus.log("Setting video transceiver to sendrecv:",d)):m&&!g?d&&(d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",Janus.log("Setting video transceiver to sendonly:",d)):!m&&g&&(d?(d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",Janus.log("Setting video transceiver to recvonly:",d)):(d=o.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",d))):n.removeVideo&&d&&(d.setDirection?d.setDirection("inactive"):d.direction="inactive",Janus.log("Setting video transceiver to inactive:",d))}else s.offerToReceiveAudio=G(n),s.offerToReceiveVideo=z(n);var h=!0===t.iceRestart;h&&(s.iceRestart=!0);Janus.debug(s);var p=q(n);if(p&&a&&"firefox"===Janus.webRTCAdapter.browserDetails.browser){Janus.log("Enabling Simulcasting for Firefox (RID)");var v=o.pc.getSenders().find((function(e){return"video"===e.track.kind}));if(v){var w=v.getParameters();w||(w={});var J=b(t.simulcastMaxBitrates);w.encodings=t.sendEncodings||[{rid:"h",active:!0,maxBitrate:J.high},{rid:"m",active:!0,maxBitrate:J.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:J.low,scaleResolutionDownBy:4}],v.setParameters(w)}}o.pc.createOffer(s).then((function(e){Janus.debug(e);var n={type:e.type,sdp:e.sdp};t.customizeSdp(n),e.sdp=n.sdp,Janus.log("Setting local description"),p&&a&&("chrome"===Janus.webRTCAdapter.browserDetails.browser||"safari"===Janus.webRTCAdapter.browserDetails.browser?(Janus.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=function(e){for(var n=e.split("\r\n"),t=!1,r=[-1],o=[-1],a=null,s=null,i=null,d=null,c=-1,u=0;u<n.length;u++){if(f=n[u].match(/m=(\w+) */)){if("video"===f[1]){if(!(r[0]<0)){c=u;break}t=!0}else if(r[0]>-1){c=u;break}}else if(t){if(n[u].match(/a=ssrc-group:SIM (\d+) (\d+) (\d+)/))return Janus.warn("The SDP already contains a SIM attribute, munging will be skipped"),e;var l=n[u].match(/a=ssrc-group:FID (\d+) (\d+)/);if(l)r[0]=l[1],o[0]=l[2],n.splice(u,1),u--;else{if(r[0]){if((g=n[u].match("a=ssrc:"+r[0]+" cname:(.+)"))&&(a=g[1]),(g=n[u].match("a=ssrc:"+r[0]+" msid:(.+)"))&&(s=g[1]),(g=n[u].match("a=ssrc:"+r[0]+" mslabel:(.+)"))&&(i=g[1]),(g=n[u].match("a=ssrc:"+r[0]+" label:(.+)"))&&(d=g[1]),0===n[u].indexOf("a=ssrc:"+o[0])){n.splice(u,1),u--;continue}if(0===n[u].indexOf("a=ssrc:"+r[0])){n.splice(u,1),u--;continue}}0!=n[u].length||(n.splice(u,1),u--)}}}if(r[0]<0){c=-1,t=!1;for(u=0;u<n.length;u++){var f;if(f=n[u].match(/m=(\w+) */)){if("video"===f[1]){if(!(r[0]<0)){c=u;break}t=!0}else if(r[0]>-1){c=u;break}}else if(t){if(r[0]<0){var m=n[u].match(/a=ssrc:(\d+)/);if(m){r[0]=m[1],n.splice(u,1),u--;continue}}else{var g;if((g=n[u].match("a=ssrc:"+r[0]+" cname:(.+)"))&&(a=g[1]),(g=n[u].match("a=ssrc:"+r[0]+" msid:(.+)"))&&(s=g[1]),(g=n[u].match("a=ssrc:"+r[0]+" mslabel:(.+)"))&&(i=g[1]),(g=n[u].match("a=ssrc:"+r[0]+" label:(.+)"))&&(d=g[1]),0===n[u].indexOf("a=ssrc:"+o[0])){n.splice(u,1),u--;continue}if(0===n[u].indexOf("a=ssrc:"+r[0])){n.splice(u,1),u--;continue}}0!==n[u].length||(n.splice(u,1),u--)}}}if(r[0]<0)return Janus.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;c<0&&(c=n.length);r[1]=Math.floor(4294967295*Math.random()),r[2]=Math.floor(4294967295*Math.random()),o[1]=Math.floor(4294967295*Math.random()),o[2]=Math.floor(4294967295*Math.random());for(u=0;u<r.length;u++)a&&(n.splice(c,0,"a=ssrc:"+r[u]+" cname:"+a),c++),s&&(n.splice(c,0,"a=ssrc:"+r[u]+" msid:"+s),c++),i&&(n.splice(c,0,"a=ssrc:"+r[u]+" mslabel:"+i),c++),d&&(n.splice(c,0,"a=ssrc:"+r[u]+" label:"+d),c++),a&&(n.splice(c,0,"a=ssrc:"+o[u]+" cname:"+a),c++),s&&(n.splice(c,0,"a=ssrc:"+o[u]+" msid:"+s),c++),i&&(n.splice(c,0,"a=ssrc:"+o[u]+" mslabel:"+i),c++),d&&(n.splice(c,0,"a=ssrc:"+o[u]+" label:"+d),c++);n.splice(c,0,"a=ssrc-group:FID "+r[2]+" "+o[2]),n.splice(c,0,"a=ssrc-group:FID "+r[1]+" "+o[1]),n.splice(c,0,"a=ssrc-group:FID "+r[0]+" "+o[0]),n.splice(c,0,"a=ssrc-group:SIM "+r[0]+" "+r[1]+" "+r[2]),(e=n.join("\r\n")).endsWith("\r\n")||(e+="\r\n");return e}(e.sdp)):"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp={type:"offer",sdp:e.sdp},o.pc.setLocalDescription(e).catch(t.error),o.mediaConstraints=s,o.iceDone||o.trickle?((o.senderTransforms||o.receiverTransforms)&&(e.e2ee=!0),t.success(e)):Janus.log("Waiting for all candidates...")}),t.error)}(e,t,r)}function O(e,n,t){(t=t||{}).success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:_;var r=t.jsep;if(n&&r)return Janus.error("Provided a JSEP to a createOffer"),void t.error("Provided a JSEP to a createOffer");if(!(n||r&&r.type&&r.sdp))return Janus.error("A valid JSEP is required for createAnswer"),void t.error("A valid JSEP is required for createAnswer");t.media="object"==typeof t.media&&t.media?t.media:{audio:!0,video:!0};var o=t.media,a=S[e];if(!a||!a.webrtcStuff)return Janus.warn("Invalid handle"),void t.error("Invalid handle");var s,i=a.webrtcStuff;if(i.trickle=(s=t.trickle,Janus.debug("isTrickleEnabled:",s),!1!==s),i.pc){if(Janus.log("Updating existing media session"),o.update=!0,t.stream)t.stream!==i.myStream&&Janus.log("Renegotiation involves a new external stream");else{if(o.addAudio){if(o.keepAudio=!1,o.replaceAudio=!1,o.removeAudio=!1,o.audioSend=!0,i.myStream&&i.myStream.getAudioTracks()&&i.myStream.getAudioTracks().length)return Janus.error("Can't add audio stream, there already is one"),void t.error("Can't add audio stream, there already is one")}else o.removeAudio?(o.keepAudio=!1,o.replaceAudio=!1,o.addAudio=!1,o.audioSend=!1):o.replaceAudio&&(o.keepAudio=!1,o.addAudio=!1,o.removeAudio=!1,o.audioSend=!0);if(i.myStream&&i.myStream.getAudioTracks()&&0!==i.myStream.getAudioTracks().length?!B(o)||o.removeAudio||o.replaceAudio||(o.keepAudio=!0):(o.replaceAudio&&(o.keepAudio=!1,o.replaceAudio=!1,o.addAudio=!0,o.audioSend=!0),B(o)&&(o.keepAudio=!1,o.addAudio=!0)),o.addVideo){if(o.keepVideo=!1,o.replaceVideo=!1,o.removeVideo=!1,o.videoSend=!0,i.myStream&&i.myStream.getVideoTracks()&&i.myStream.getVideoTracks().length)return Janus.error("Can't add video stream, there already is one"),void t.error("Can't add video stream, there already is one")}else o.removeVideo?(o.keepVideo=!1,o.replaceVideo=!1,o.addVideo=!1,o.videoSend=!1):o.replaceVideo&&(o.keepVideo=!1,o.addVideo=!1,o.removeVideo=!1,o.videoSend=!0);i.myStream&&i.myStream.getVideoTracks()&&0!==i.myStream.getVideoTracks().length?!q(o)||o.removeVideo||o.replaceVideo||(o.keepVideo=!0):(o.replaceVideo&&(o.keepVideo=!1,o.replaceVideo=!1,o.addVideo=!0,o.videoSend=!0),q(o)&&(o.keepVideo=!1,o.addVideo=!0)),o.addData&&(o.data=!0)}if(B(o)&&o.keepAudio&&q(o)&&o.keepVideo)return a.consentDialog(!1),void j(e,r,o,t,i.myStream)}else o.update=!1,o.keepAudio=!1,o.keepVideo=!1;if(o.update&&!i.streamExternal){if(o.removeAudio||o.replaceAudio){if(i.myStream&&i.myStream.getAudioTracks()&&i.myStream.getAudioTracks().length){var d=i.myStream.getAudioTracks()[0];Janus.log("Removing audio track:",d),i.myStream.removeTrack(d);try{d.stop()}catch(I){}}if(i.pc.getSenders()&&i.pc.getSenders().length){var c=!0;if(o.replaceAudio&&Janus.unifiedPlan&&(c=!1),c)for(var u of i.pc.getSenders())u&&u.track&&"audio"===u.track.kind&&(Janus.log("Removing audio sender:",u),i.pc.removeTrack(u))}}if(o.removeVideo||o.replaceVideo){if(i.myStream&&i.myStream.getVideoTracks()&&i.myStream.getVideoTracks().length){var l=i.myStream.getVideoTracks()[0];Janus.log("Removing video track:",l),i.myStream.removeTrack(l);try{l.stop()}catch(A){}}if(i.pc.getSenders()&&i.pc.getSenders().length){var f=!0;if(o.replaceVideo&&Janus.unifiedPlan&&(f=!1),f)for(var m of i.pc.getSenders())m&&m.track&&"video"===m.track.kind&&(Janus.log("Removing video sender:",m),i.pc.removeTrack(m))}}}if(t.stream){var g=t.stream;return Janus.log("MediaStream provided by the application"),Janus.debug(g),o.update&&i.myStream&&i.myStream!==t.stream&&!i.streamExternal&&(Janus.stopAllTracks(i.myStream),i.myStream=null),i.streamExternal=!0,a.consentDialog(!1),void j(e,r,o,t,g)}if(B(o)||q(o)){if(!Janus.isGetUserMediaAvailable())return void t.error("getUserMedia not available");var h={mandatory:{},optional:[]};a.consentDialog(!0);var p=B(o);p&&o&&"object"==typeof o.audio&&(p=o.audio);var v=q(o);if(v&&o){var b=!0===t.simulcast,w=!0===t.simulcast2;if(!b&&!w||r||o.video||(o.video="hires"),o.video&&"screen"!=o.video&&"window"!=o.video)if("object"==typeof o.video)v=o.video;else{var J=0,y=0;"lowres"===o.video?(y=240,240,J=320):"lowres-16:9"===o.video?(y=180,180,J=320):"hires"===o.video||"hires-16:9"===o.video||"hdres"===o.video?(y=720,720,J=1280):"fhdres"===o.video?(y=1080,1080,J=1920):"4kres"===o.video?(y=2160,2160,J=3840):"stdres"===o.video?(y=480,480,J=640):"stdres-16:9"===o.video?(y=360,360,J=640):(Janus.log("Default video setting is stdres 4:3"),y=480,480,J=640),Janus.log("Adding media constraint:",o.video),v={height:{ideal:y},width:{ideal:J}},Janus.log("Adding video constraint:",v)}else if("screen"===o.video||"window"===o.video){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return h.video={},o.screenshareFrameRate&&(h.video.frameRate=o.screenshareFrameRate),o.screenshareHeight&&(h.video.height=o.screenshareHeight),o.screenshareWidth&&(h.video.width=o.screenshareWidth),h.audio=o.captureDesktopAudio,void navigator.mediaDevices.getDisplayMedia(h).then((function(n){a.consentDialog(!1),B(o)&&!o.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(a){n.addTrack(a.getAudioTracks()[0]),j(e,r,o,t,n)})):j(e,r,o,t,n)}),(function(e){a.consentDialog(!1),t.error(e)}));function k(n,s){a.consentDialog(!1),n?t.error(n):j(e,r,o,t,s)}function C(e,n,t){Janus.log("Adding media constraint (screen capture)"),Janus.debug(e),navigator.mediaDevices.getUserMedia(e).then((function(e){t?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(t){e.addTrack(t.getAudioTracks()[0]),n(null,e)})):n(null,e)})).catch((function(e){a.consentDialog(!1),n(e)}))}if("chrome"===Janus.webRTCAdapter.browserDetails.browser){var T=Janus.webRTCAdapter.browserDetails.version,D=33;window.navigator.userAgent.match("Linux")&&(D=35),T>=26&&T<=D?C(h={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate,chromeMediaSource:"screen"}},audio:B(o)&&!o.keepAudio},k):Janus.extension.getScreen((function(e,n){if(e)return a.consentDialog(!1),t.error(e);(h={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=n,C(h,k,B(o)&&!o.keepAudio)}))}else if("firefox"===Janus.webRTCAdapter.browserDetails.browser){if(!(Janus.webRTCAdapter.browserDetails.version>=33)){var R=new Error("NavigatorUserMediaError");return R.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",a.consentDialog(!1),void t.error(R)}C(h={video:{mozMediaSource:o.video,mediaSource:o.video},audio:B(o)&&!o.keepAudio},(function(e,n){if(k(e,n),!e)var t=n.currentTime,r=window.setInterval((function(){n||window.clearInterval(r),n.currentTime==t&&(window.clearInterval(r),n.onended&&n.onended()),t=n.currentTime}),500)}))}return}}o&&"screen"===o.video||navigator.mediaDevices.enumerateDevices().then((function(n){var s=n.some((function(e){return"audioinput"===e.kind})),i=function(e){if(Janus.debug("isScreenSendEnabled:",e),!e)return!1;if("object"!=typeof e.video||"object"!=typeof e.video.mandatory)return!1;var n=e.video.mandatory;if(n.chromeMediaSource)return"desktop"===n.chromeMediaSource||"screen"===n.chromeMediaSource;if(n.mozMediaSource)return"window"===n.mozMediaSource||"screen"===n.mozMediaSource;if(n.mediaSource)return"window"===n.mediaSource||"screen"===n.mediaSource;return!1}(o)||n.some((function(e){return"videoinput"===e.kind})),d=B(o),c=q(o),u=function(e){return Janus.debug("isAudioSendRequired:",e),!!e&&(!1!==e.audio&&!1!==e.audioSend&&(void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio))}(o),l=function(e){return Janus.debug("isVideoSendRequired:",e),!!e&&(!1!==e.video&&!1!==e.videoSend&&(void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo))}(o);if(d||c||u||l){var f=!!d&&s,m=!!c&&i;if(!f&&!m)return a.consentDialog(!1),t.error("No capture device found"),!1;if(!f&&u)return a.consentDialog(!1),t.error("Audio capture is required, but no capture device found"),!1;if(!m&&l)return a.consentDialog(!1),t.error("Video capture is required, but no capture device found"),!1}var h={audio:!(!s||o.keepAudio)&&p,video:!(!i||o.keepVideo)&&v};Janus.debug("getUserMedia constraints",h),h.audio||h.video?navigator.mediaDevices.getUserMedia(h).then((function(n){a.consentDialog(!1),j(e,r,o,t,n)})).catch((function(e){a.consentDialog(!1),t.error({code:e.code,name:e.name,message:e.message})})):(a.consentDialog(!1),j(e,r,o,t,g))})).catch((function(e){a.consentDialog(!1),t.error(e)}))}else j(e,r,o,t)}function $(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:_;var t=n.jsep,r=S[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var o=r.webrtcStuff;if(t){if(!o.pc)return Janus.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void n.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");o.pc.setRemoteDescription(t).then((function(){if(Janus.log("Remote description accepted!"),o.remoteSdp=t.sdp,o.candidates&&o.candidates.length>0){for(var e=0;e<o.candidates.length;e++){var r=o.candidates[e];Janus.debug("Adding remote candidate:",r),r&&!0!==r.completed?o.pc.addIceCandidate(r):o.pc.addIceCandidate(Janus.endOfCandidates)}o.candidates=[]}n.success()}),n.error)}else n.error("Invalid JSEP")}function L(e,n){var t=S[e];if(!t||!t.webrtcStuff)return Janus.warn("Invalid handle"),0;var r=n?"remote":"local",o=t.webrtcStuff;return o.volume[r]||(o.volume[r]={value:0}),!o.pc.getStats||"chrome"!==Janus.webRTCAdapter.browserDetails.browser&&"safari"!==Janus.webRTCAdapter.browserDetails.browser?(Janus.warn("Getting the "+r+" volume unsupported by browser"),0):n&&!o.remoteStream?(Janus.warn("Remote stream unavailable"),0):n||o.myStream?o.volume[r].timer?o.volume[r].value:(Janus.log("Starting "+r+" volume monitor"),o.volume[r].timer=setInterval((function(){o.pc.getStats().then((function(e){e.forEach((function(e){e&&"audio"===e.kind&&(n&&!e.remoteSource||!n&&"media-source"!==e.type||(o.volume[r].value=e.audioLevel?e.audioLevel:0))}))}))}),200),0):(Janus.warn("Local stream unavailable"),0)}function N(e,n){var t=S[e];if(!t||!t.webrtcStuff)return Janus.warn("Invalid handle"),!0;var r=t.webrtcStuff;return r.pc?r.myStream?n?r.myStream.getVideoTracks()&&0!==r.myStream.getVideoTracks().length?!r.myStream.getVideoTracks()[0].enabled:(Janus.warn("No video track"),!0):r.myStream.getAudioTracks()&&0!==r.myStream.getAudioTracks().length?!r.myStream.getAudioTracks()[0].enabled:(Janus.warn("No audio track"),!0):(Janus.warn("Invalid local MediaStream"),!0):(Janus.warn("Invalid PeerConnection"),!0)}function U(e,n,t){var r=S[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),!1;var o=r.webrtcStuff;return o.pc?o.myStream?n?o.myStream.getVideoTracks()&&0!==o.myStream.getVideoTracks().length?(o.myStream.getVideoTracks()[0].enabled=!t,!0):(Janus.warn("No video track"),!1):o.myStream.getAudioTracks()&&0!==o.myStream.getAudioTracks().length?(o.myStream.getAudioTracks()[0].enabled=!t,!0):(Janus.warn("No audio track"),!1):(Janus.warn("Invalid local MediaStream"),!1):(Janus.warn("Invalid PeerConnection"),!1)}function F(e){var n=S[e];if(!n||!n.webrtcStuff)return Janus.warn("Invalid handle"),"Invalid handle";var t=n.webrtcStuff;return t.pc?t.pc.getStats?t.bitrate.timer?t.bitrate.value:(Janus.log("Starting bitrate timer (via getStats)"),t.bitrate.timer=setInterval((function(){t.pc.getStats().then((function(e){e.forEach((function(e){if(e){var n=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?n=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(n=!0),n)if(t.bitrate.bsnow=e.bytesReceived,t.bitrate.tsnow=e.timestamp,null===t.bitrate.bsbefore||null===t.bitrate.tsbefore)t.bitrate.bsbefore=t.bitrate.bsnow,t.bitrate.tsbefore=t.bitrate.tsnow;else{var r=t.bitrate.tsnow-t.bitrate.tsbefore;"safari"===Janus.webRTCAdapter.browserDetails.browser&&(r/=1e3);var o=Math.round(8*(t.bitrate.bsnow-t.bitrate.bsbefore)/r);"safari"===Janus.webRTCAdapter.browserDetails.browser&&(o=parseInt(o/1e3)),t.bitrate.value=o+" kbits/sec",t.bitrate.bsbefore=t.bitrate.bsnow,t.bitrate.tsbefore=t.bitrate.tsnow}}}))}))}),1e3),"0 kbits/sec"):(Janus.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"):"Invalid PeerConnection"}function _(e){Janus.error("WebRTC error:",e)}function W(e,r){Janus.log("Cleaning WebRTC stuff");var o=S[e];if(o){var a=o.webrtcStuff;if(a){if(!0===r){var s={janus:"hangup",transaction:Janus.randomString(12)};o.token&&(s.token=o.token),h&&(s.apisecret=h),Janus.debug("Sending hangup request (handle="+e+"):"),Janus.debug(s),n?(s.session_id=J,s.handle_id=e,t.send(JSON.stringify(s))):Janus.httpAPICall(i+"/"+J+"/"+e,{verb:"POST",withCredentials:f,body:s})}a.remoteStream=null,a.volume&&(a.volume.local&&a.volume.local.timer&&clearInterval(a.volume.local.timer),a.volume.remote&&a.volume.remote.timer&&clearInterval(a.volume.remote.timer)),a.volume={},a.bitrate.timer&&clearInterval(a.bitrate.timer),a.bitrate.timer=null,a.bitrate.bsnow=null,a.bitrate.bsbefore=null,a.bitrate.tsnow=null,a.bitrate.tsbefore=null,a.bitrate.value=null,!a.streamExternal&&a.myStream&&(Janus.log("Stopping local stream tracks"),Janus.stopAllTracks(a.myStream)),a.streamExternal=!1,a.myStream=null;try{a.pc.close()}catch(e){}a.pc=null,a.candidates=null,a.mySdp=null,a.remoteSdp=null,a.iceDone=!1,a.dataChannel={},a.dtmfSender=null,a.senderTransforms=null,a.receiverTransforms=null}o.oncleanup()}}function B(e){return Janus.debug("isAudioSendEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function G(e){return Janus.debug("isAudioRecvEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function q(e){return Janus.debug("isVideoSendEnabled:",e),!e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function z(e){return Janus.debug("isVideoRecvEnabled:",e),!e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}I(e),this.getServer=function(){return i},this.isConnected=function(){return w},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.reconnect=!0,I(e)},this.getSessionId=function(){return J},this.getInfo=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,Janus.log("Getting info on Janus instance"),!w)return Janus.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var r=Janus.randomString(12),o={janus:"info",transaction:r};g&&(o.token=g);h&&(o.apisecret=h);if(n)return C[r]=function(n){Janus.log("Server info:"),Janus.debug(n),"server_info"!==n.janus&&Janus.error("Ooops: "+n.error.code+" "+n.error.reason),e.success(n)},void t.send(JSON.stringify(o));Janus.httpAPICall(i,{verb:"POST",withCredentials:f,body:o,success:function(n){Janus.log("Server info:"),Janus.debug(n),"server_info"!==n.janus&&Janus.error("Ooops: "+n.error.code+" "+n.error.reason),e.success(n)},error:function(n,t){Janus.error(n+":",t),""===t?e.error(n+": Is the server down?"):e.error(n+": "+t)}})}(e)},this.destroy=function(a){!function(a){a=a||{},a.success="function"==typeof a.success?a.success:Janus.noop,a.error="function"==typeof a.error?a.error:Janus.noop;var s=!0===a.unload,d=!0;void 0!==a.notifyDestroyed&&null!==a.notifyDestroyed&&(d=!0===a.notifyDestroyed);var c=!0===a.cleanupHandles;if(Janus.log("Destroying session "+J+" (unload="+s+")"),!J)return Janus.warn("No session to destroy"),a.success(),void(d&&e.destroyed());if(c)for(var u in S)V(u,{noRequest:!0});if(!w)return Janus.warn("Is the server down? (connected=false)"),J=null,void a.success();var l={janus:"destroy",transaction:Janus.randomString(12)};g&&(l.token=g);h&&(l.apisecret=h);if(s)return n?(t.onclose=null,t.close(),t=null):navigator.sendBeacon(i+"/"+J,JSON.stringify(l)),Janus.log("Destroyed session:"),J=null,w=!1,a.success(),void(d&&e.destroyed());if(n){l.session_id=J;var m=function(){for(var e in r)t.removeEventListener(e,r[e]);t.removeEventListener("message",p),t.removeEventListener("error",v),o&&clearTimeout(o),t.close()},p=function(n){var t=JSON.parse(n.data);t.session_id==l.session_id&&t.transaction==l.transaction&&(m(),a.success(),d&&e.destroyed())},v=function(n){m(),a.error("Failed to destroy the server: Is the server down?"),d&&e.destroyed()};return t.addEventListener("message",p),t.addEventListener("error",v),void(1===t.readyState?t.send(JSON.stringify(l)):v())}Janus.httpAPICall(i+"/"+J,{verb:"POST",withCredentials:f,body:l,success:function(n){Janus.log("Destroyed session:"),Janus.debug(n),J=null,w=!1,"success"!==n.janus&&Janus.error("Ooops: "+n.error.code+" "+n.error.reason),a.success(),d&&e.destroyed()},error:function(n,t){Janus.error(n+":",t),J=null,w=!1,a.success(),d&&e.destroyed()}})}(a)},this.attach=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:Janus.noop,e.iceState="function"==typeof e.iceState?e.iceState:Janus.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:Janus.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:Janus.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:Janus.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:Janus.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:Janus.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:Janus.noop,e.ondata="function"==typeof e.ondata?e.ondata:Janus.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:Janus.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:Janus.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:Janus.noop,!w)return Janus.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var r=e.plugin;if(!r)return Janus.error("Invalid plugin"),void e.error("Invalid plugin");var o=e.opaqueId,a=e.token?e.token:g,s=Janus.randomString(12),d={janus:"attach",plugin:r,opaque_id:o,transaction:s};a&&(d.token=a);h&&(d.apisecret=h);if(n)return C[s]=function(n){if(Janus.debug(n),"success"!==n.janus)return Janus.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var t=n.data.id;Janus.log("Created handle: "+t);var o={session:y,plugin:r,id:t,token:a,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return t},getPlugin:function(){return r},getVolume:function(){return L(t,!0)},getRemoteVolume:function(){return L(t,!0)},getLocalVolume:function(){return L(t,!1)},isAudioMuted:function(){return N(t,!1)},muteAudio:function(){return U(t,!1,!0)},unmuteAudio:function(){return U(t,!1,!1)},isVideoMuted:function(){return N(t,!0)},muteVideo:function(){return U(t,!0,!0)},unmuteVideo:function(){return U(t,!0,!1)},getBitrate:function(){return F(t)},send:function(e){A(t,e)},data:function(e){E(t,e)},dtmf:function(e){M(t,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){O(t,!0,e)},createAnswer:function(e){O(t,!1,e)},handleRemoteJsep:function(e){$(t,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){W(t,!0===e)},detach:function(e){V(t,e)}};S[t]=o,e.success(o)},d.session_id=J,void t.send(JSON.stringify(d));Janus.httpAPICall(i+"/"+J,{verb:"POST",withCredentials:f,body:d,success:function(n){if(Janus.debug(n),"success"!==n.janus)return Janus.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var t=n.data.id;Janus.log("Created handle: "+t);var o={session:y,plugin:r,id:t,token:a,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return t},getPlugin:function(){return r},getVolume:function(){return L(t,!0)},getRemoteVolume:function(){return L(t,!0)},getLocalVolume:function(){return L(t,!1)},isAudioMuted:function(){return N(t,!1)},muteAudio:function(){return U(t,!1,!0)},unmuteAudio:function(){return U(t,!1,!1)},isVideoMuted:function(){return N(t,!0)},muteVideo:function(){return U(t,!0,!0)},unmuteVideo:function(){return U(t,!0,!1)},getBitrate:function(){return F(t)},send:function(e){A(t,e)},data:function(e){E(t,e)},dtmf:function(e){M(t,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){O(t,!0,e)},createAnswer:function(e){O(t,!1,e)},handleRemoteJsep:function(e){$(t,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){W(t,!0===e)},detach:function(e){V(t,e)}};S[t]=o,e.success(o)},error:function(n,t){Janus.error(n+":",t),""===t?e.error(n+": Is the server down?"):e.error(n+": "+t)}})}(e)}}function getDateString(e){var n;return("0"+(n=e?new Date(Date.parse(e)):new Date).getUTCHours()).slice(-2)+":"+("0"+n.getUTCMinutes()).slice(-2)+":"+("0"+n.getUTCSeconds()).slice(-2)}function getQueryParams(e){e=e.split("+").join(" ");for(var n,t={},r=/[?&]?([^=]+)=([^&]*)/g;n=r.exec(e);)t[decodeURIComponent(n[1])]=decodeURIComponent(n[2]);return t}function Loader(e){this.divLoader=e,this.show=function(e){e?this.divLoader.attr("data-text",e):this.divLoader.removeAttr("data-text"),this.divLoader.addClass("is-active")},this.hide=function(){this.divLoader.removeClass("is-active")}}function DebugUtils(e){this.enabled=!1,this.testSwipesInterval=null,this.remoteChat=e,this.isDebugEnabled=function(){return this.enabled},this.enable=function(){this.enabled=!0,$(".debug-stuff").removeClass("d-none"),$("div").addClass("debug-border")},this.disable=function(){this.enabled=!1,$(".debug-stuff").addClass("d-none"),$("div").removeClass("debug-border")},this.toggleTestSwipes=function(e,n,t){return this.testSwipesInterval?(clearInterval(this.testSwipesInterval),this.testSwipesInterval=null,"Off"):(function(e,n,t,r){void 0===n&&(n=500),void 0===t&&(t=200),void 0===r&&(r=1e3),e.testSwipesInterval=setInterval((function(){e.remoteChat.sendData(`swipe,${n},${t},0,${t},500`)}),r)}(this,e,n,t),"On")}}function CheatCodes(){this.keys=[],this.cheatMinLength=4,this.cheatTimeout=null,this.cheatTimeoutDelay=500;var e=this;this.restartCheatInterval=function(){var e,n;this.cheatTimeout&&(window.clearTimeout(this.cheatTimeout),this.cheatTimeout=null),e=this,n=this.cheatTimeoutDelay,e.cheatTimeout=window.setTimeout((function(){var n=e.keys.join("");e.keys=[],n.length>=e.cheatMinLength&&ui.emit("CheatCodes.onCheatEntered",n),e.cheatTimeout=null}),n)},$(document).on("keydown",(function(n){e.restartCheatInterval(),n.keyCode>=65&&n.keyCode<=90&&e.keys.push(n.key.toLowerCase())}))}function RemoteKeyboard(e){this.remoteChat=e,this.manage=!1;var n=this;ui.on("RemoteChat.onManagementStart",(function(){this.manage=!0}),this),ui.on("RemoteChat.onManagementStop",(function(){this.manage=!1}),this),$(document).on("keydown",(function(e){if(!(!n.manage||e.altKey||e.ctrlKey||1!=e.key.length&&"Backspace"!==e.key&&"Delete"!==e.key&&"Enter"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key&&"Home"!==e.key&&"End"!==e.key)){var t=e.key.replace("%","%25").replace(",","%2C");n.remoteChat.sendData(`key,${t}`),e.preventDefault(),e.stopPropagation()}}))}function RemoteClipboard(e){this.remoteChat=e,this.manage=!1;var n=this;$(document).on("visibilitychange",(function(e){n.manage&&$("#textareaClipboard").focus(),console.log("Visibility of page has changed!")})),ui.on("RemoteChat.onManagementStart",(function(){$("#textareaClipboard").focus(),this.manage=!0}),this),ui.on("RemoteChat.onManagementStop",(function(){this.manage=!1}),this),ui.on("RemoteClipboard.onRemoteCopy",(function(e){var n=$("#textareaClipboard");n.focus(),n.val(e),n.select(),document.execCommand("copy"),ui.showSuccess("Device clipboard is sent to the host","Clipboard",null,null,2e3)}),this),$("#textareaClipboard").bind("paste",(function(e){if(n.manage){var t=e.originalEvent.clipboardData.getData("text").replace("%","%25").replace(",","%2C");n.remoteChat.sendData(`paste,${t}`),ui.showSuccess("Clipboard is sent to the device","Clipboard",null,null,2e3)}}))}function SessionMonitoring(e){this.remoteChat=e,this.pingInterval=null,this.pingIntervalDelayMillis=2e3,this.criticalDelay=3e4,this.lastPingSentFrom=0,this.lastPongReceivedFrom=0,this.start=function(){var e,n;this.stop(),e=this,n=this.pingIntervalDelayMillis,e.pingInterval=window.setInterval((function(){var n=(new Date).getTime();e.lastPingSentFrom&&(e.lastPongReceivedFrom+2*e.pingIntervalDelayMillis<n&&ui.showWarning("Network problems","Device management",null,null,e.pingIntervalDelayMillis),e.lastPongReceivedFrom+e.criticalDelay<n&&ui.emit("Session.Disconnect")),e.sendPing(n)}),n)},ui.on("RemoteChat.onManagementStart",(function(){this.start()}),this),ui.on("RemoteChat.onManagementStop",(function(){this.stop()}),this),ui.on("SessionMonitoring.onPong",(function(e){this.getPong(e)}),this),this.stop=function(){window.clearInterval(this.pingInterval),this.pingInterval=null,this.lastPingSentFrom=0,this.lastPongReceivedFrom=0},this.sendPing=function(e){this.remoteChat.sendData(`ping,${e}`),this.lastPingSentFrom=e},this.getPong=function(e){(e=parseInt(e))>this.lastPongReceivedFrom&&(this.lastPongReceivedFrom=e)}}function UI(){this.deviceName=null,this.initIsTextroomReady=!1,this.initIsStreamingReady=!1,this.connDialog=null,this.connIsTextroomReady=!1,this.connIsStreamingReady=!1,this.errors=new Map,this.errorIntervals=new Map,this.events={},this.on=function(e,n,t){this.events[e]||(this.events[e]=[]),this.events[e].push([n,t])},this.removeListener=function(e,n){this.events[e]||console.error(`UI.Events: can't remove a listener. Event "${e}" doesn't exits.`);this.events[e]=this.events[e].filter((function(e){return e!==n}))},this.emit=function(e,n){this.events[e]||console.error(`UI.Events: can't emit a listener. Event "${e}" doesn't exits.`),this.events[e].forEach((function(t,r){console.debug(`UI.Events: run handler #${r+1} for event "${e}" with data`,n),t[0].apply(t[1],[n])}))},this.fillForm=function(){if(document.location.search){var e=getQueryParams(document.location.search);e.session&&$("#input-session-id").val(e.session),e.pin&&$("#input-pin").val(e.pin)}},this.initStart=function(){this.fillForm(),this.initIsTextroomReady=!1,this.initIsStreamingReady=!1,loader.show("Setup ..")},this.initAbort=function(){this.initIsTextroomReady=!1,this.initIsStreamingReady=!1,loader.hide()},this.initTextroomReady=function(){console.debug("UI.Initialization: textroom ready"),this.initIsTextroomReady=!0,this.checkInitReady()},this.initStreamingReady=function(){console.debug("UI.Initialization: streaming ready"),this.initIsStreamingReady=!0,this.checkInitReady()},this.checkInitReady=function(){this.initIsStreamingReady&&this.initIsTextroomReady&&(console.debug("UI.Initialization: ready. Show login form"),loader.hide())},this.connStart=function(){this.connIsTextroomReady=!1,this.connIsStreamingReady=!1,loader.show("Connecting to device ..")},this.connAbort=function(){this.initIsTextroomReady=!1,this.initIsStreamingReady=!1,loader.hide()},this.connTextroomReady=function(){console.debug("UI.Connection: textroom ready"),this.connIsTextroomReady=!0,this.checkConnReady()},this.connStreamingReady=function(){console.debug("UI.Connection: streaming ready"),this.connIsStreamingReady=!0,this.checkConnReady()},this.checkConnReady=function(){this.connIsStreamingReady&&this.connIsTextroomReady&&(console.debug("UI.Connection: ready. Switching from login form to main window"),loader.hide(),$("#login-form-container").addClass("d-none"),$("#main-window").removeClass("d-none"))},this.showErrorModal=function(e,n,t,r){var o,a,s,i=void 0!==n?n:e,d=this.errors.get(i),c=(new Date).getTime();if(d&&c-d[1]<5e3)console.info("Error (repeat)",e,n);else{console.error("Error",e,n);var u=bootbox.alert({message:e,callback:t});r===parseInt(r,10)&&void 0!==t&&(o=this,a=c,s=window.setInterval((function(){var e=o.errorIntervals.get(a);e[1]+=1,e[3].find(".modal-footer .btn-primary").html(`${e[4]} (${(e[2]-e[1]).toString()})`),e[1]>=e[2]&&(window.clearInterval(e[0]),t(),e[3].modal("hide"),o.errorIntervals.delete(a))}),1e3),o.errorIntervals.set(c,[s,-1,r,u,u.find(".modal-footer .btn-primary").html()]))}this.errors.set(i,[e,c])},this.showNotify=function(e,n,t,r,o,a){var s={};"function"==typeof r&&(s.onclick=r),"function"==typeof o&&(s.onHidden=o),"number"==typeof a&&(s.timeOut=a),toastr[e](n,t,s)},this.showInfo=function(e,n,t,r,o){this.showNotify("info",e,n,t,r,o)},this.showWarning=function(e,n,t,r,o){this.showNotify("warning",e,n,t,r,o)},this.showSuccess=function(e,n,t,r,o){this.showNotify("success",e,n,t,r,o)},this.showError=function(e,n,t,r,o){this.showNotify("error",e,n,t,r,o)},this.setDevice=function(e,n){this.deviceId=e,this.deviceName=n,$("#textDeviceName").html(n)},this.sessionClosedRemotely=function(e){e=e||"Session has been terminated by remote device",this.showErrorModal(e,"session_closed",(function(){window.location.reload()}),5)},this.disconnect=function(e){e=e||"Disconnected",this.showErrorModal(e,"session_closed",(function(){window.location.reload()}),5)}}function RemoteChat(e,n,t,r){this.textroom=null,this.chatElem=e,this.chatForm=n,this.messageInput=t,this.sendButton=r,this.transactions={},this.participants=new Map,this.sessionId="",this.pin="",this.userId="",this.userName="",this.commandsProcessor=null;var o=this;this.setCommandsProcessor=function(e){this.commandsProcessor=e},this.startTransaction=function(e,n,t){var r=Janus.randomString(12);return console.debug("chat: transaction start",r,e,n,t),e.transaction=r,this.transactions[r]=n,console.debug("now we have",Object.keys(this.transactions).length,"active transactions"),this.textroom.data({text:JSON.stringify(e),error:function(e){console.error("chat: transaction send data error",e),bootbox.alert(e),t&&t(e)}}),r},this.processTransactionAnswer=function(e,n){if(this.transactions[e]){console.debug("chat: transaction answered",e,n);var t=this.transactions[e](n);return delete this.transactions[e],console.debug("chat: now we have",Object.keys(this.transactions).length,"active transactions"),!([void 0,null].indexOf(t)<0)||t}return!1},this.disableAllChatControls=function(){this.sendButton.attr("disabled",!0),this.messageInput.attr("disabled",!0)},this.enableAllChatControls=function(){this.sendButton.removeAttr("disabled"),this.messageInput.removeAttr("disabled"),this.chatElem.css("height","250px")},this.chatScrollDown=function(){this.chatElem.scrollTop(this.chatElem.prop("scrollHeight"))},this.chatForm.on("submit",(function(e){var n=o.messageInput.val();o.sendData(n),e.preventDefault()})),this.setUp=function(e){this.textroom=e,console.info("chat: set up ..");this.textroom.send({message:{request:"setup"}})},this.startRoom=function(e,n){this.sessionId=e,this.pin=n,this.userId=`admin:${e}`,this.userName=`admin:${e}`,this.registerUserAndJoinRoom()},this.leaveRoom=function(){this.disableAllChatControls();var e={textroom:"leave",room:this.sessionId};console.debug("chat: leaving room",e),this.startTransaction(e,(function(e){o.textroom.hangup()}))},this.registerUserAndJoinRoom=function(){this.disableAllChatControls();var e={textroom:"join",room:this.sessionId,pin:this.pin,username:this.userId,display:this.userName};console.debug("chat: join room & register user",e),this.startTransaction(e,(function(e){if("error"===e.textroom)return ui.connAbort(),void(417===e.error_code?ui.showError(`Session ${o.sessionId} does not exist`,"no_session"):ui.showError(e.error,"transaction_error"));console.debug("chat: we are in the room!");var n=null;if(e.participants&&e.participants.length>0){for(var t in e.participants){var r=e.participants[t],a=r.username,s=r.display?r.display:r.username;o.participants.set(a,s),s!==o.userId&&o.appendMessageToChat(`<i>${s} already in room</i>`),"device:"===a.substring(0,7).toLowerCase()&&(n?console.warn("chat: it seems the room has more than one device!"):n=[a,s])}console.debug("chat: room has participants",Array.from(o.participants.entries()))}n||1!==o.participants.size||(n=o.participants.entries().next().value),n?ui.setDevice(n[0],n[1]):console.error("chat: can not determine device from participants"),o.enableAllChatControls(),ui.connTextroomReady(),ui.emit("RemoteChat.onManagementStart")}),(function(e){ui.connAbort(),o.disableAllChatControls(),console.error("chat: joining room error",e),ui.showError(e,"join_error")}))},this.sendData=function(e){if(e){var n={textroom:"message",room:this.sessionId,text:e};console.debug("textroom: sending chat message",n),this.disableAllChatControls(),this.startTransaction(n,(function(e){o.messageInput.val(""),o.enableAllChatControls()}),(function(e){console.error("textroom: sending chat message error",e),ui.showError(e,"textroom_send_error")}))}},this.cleanup=function(){console.debug("chat: cleanup"),this.disableAllChatControls(),ui.emit("RemoteChat.onManagementStop")},this.processIncomingMessage=function(e,n,t,r){console.debug("chat: incoming message",e,n,t,r),null!==this.commandsProcessor&&this.commandsProcessor.process(e),e=this._formatMessageForHTML(e);var o=getDateString(t);r?this.appendMessageToChat(`<b>[hidden message from ${n}]:</b> ${e}</p>`,"gray",o):this.appendMessageToChat(`<b>${n}:</b> ${e}</p>`,"black",o)},this.processAnnouncement=function(e,n){console.debug("chat: announcement",e,n),e=this._formatMessageForHTML(e);var t=getDateString(n);this.appendMessageToChat(`<i>${e}</i>`,"purple",t)},this.processJoin=function(e,n){console.debug("chat: user joined",e,n),this.participants.set(e,n||e),this.userId,this.appendMessageToChat(`<i>${this.participants.get(e)} joined</i>`,"green")},this.processLeave=function(e){console.debug("chat: user leaved",e),this.appendMessageToChat(`<i>${this.participants.get(e)} leaved</i>`,"green"),this.participants.delete(e),e===ui.deviceId&&ui.sessionClosedRemotely("Device left the session")},this.processKick=function(e){console.debug("chat: user kicked",e),this.appendMessageToChat(`<i>${this.participants.get(e)} kicked</i>`,"red"),this.participants.delete(e),e===this.userId&&ui.sessionClosedRemotely("You has been kicked from session")},this.processRoomDestroy=function(e){e===this.sessionId&&(console.debug("chat: current room has been destroyed",e),this.appendMessageToChat(`<b>Session ${this.sessionId} has been closed</b>`),ui.sessionClosedRemotely("Session has been closed"))},this.appendMessageToChat=function(e,n,t){t=t||getDateString(),this.chatElem.append(`<p style="color: ${n};">[${t}] ${e}</p>`),this.chatScrollDown()},this._formatMessageForHTML=function(e){return e=(e=e.replace(new RegExp("<","g"),"&lt")).replace(new RegExp(">","g"),"&gt")}}function Commands(e,n){this.removeVideo=n,this.remoteChat=e,this.commands=new Map;var t=this;this.commands.set("streamingVideoResolution",(function(e,n){t.removeVideo.setResolution(e,n)})),this.commands.set("pong",(function(e){ui.emit("SessionMonitoring.onPong",e)})),this.commands.set("copy",(function(e){ui.emit("RemoteClipboard.onRemoteCopy",e.replace("%2C",",").replace("%25","%"))})),this.process=function(e){let n,t=this.splitCSV(e),r=t[0],o=this.commands.get(r);return o?(console.info(`Commands: get command "${r}" with args ${t.slice(1)}`),n=o.apply(null,t.slice(1))):console.debug(`Commands: skip regular message "${e}"`),n},this.csvSeparator=",",this.quoteChars="\"'",this.splitCSV=function(e){let n=[],t="",r=!1,o=!1,a="";for(let s of e){let e=this.quoteChars.indexOf(s)>-1;s===this.csvSeparator?o&&!r?t+=s:(n.push(t),t="",r=!1,o=!1,a=""):e?o?s===a?r=!0:t+=s:(""===t.trim()&&(t=""),o=!0,a=s):r||(t+=s)}return n.push(t),n}}function RemoteVideo(e,n,t){this.streaming=null,this.remoteVideoElem=e,this.videoLoader=n,this.videoStats=t,this.stream=null,this.mountpointId=null,this.videoResolution=null,this.isVideoAlreadyPlayed=!1;var r=this;this.getStreamVideotracks=function(){return this.stream?this.stream.getVideoTracks():[]},this.noRemoteVideo=function(){this.isVideoAlreadyPlayed&&!window.debugUtils.isDebugEnabled()||this.videoLoader.show(),console.debug("video: no remote")},this.hasRemoteVideo=function(){this.videoLoader.hide(),console.debug("video: has remote")},this.setStreamingPluginHandle=function(e){this.streaming=e},this.setResolution=function(e,n){this.videoResolution=[e,n],this.remoteVideoElem.attr("width",e).attr("height",n)},this.setStream=function(e){let n=!1;this.stream!==e&&(this.stream=e,n=!0),this.getStreamVideotracks().length>0?(n&&Janus.attachMediaStream(this.remoteVideoElem.get(0),this.stream),this.hasRemoteVideo(),["chrome","firefox","safari"].indexOf(Janus.webRTCAdapter.browserDetails.browser)>=0&&this.videoStats.start()):(this.noRemoteVideo(),this.videoStats.stop())},this.startStreamMountpoint=function(e,n){this.mountpointId=e,console.info("streaming: starting mountpoint id "+e+" with pin "+n);var t={request:"watch",id:e,pin:n};this.streaming.send({message:t}),this.noRemoteVideo()},this.remoteVideoElem.on("playing",(function(n){console.debug("video: playing event",n),r.getStreamVideotracks().length>0?(r.videoStats.start(),e=r.remoteVideoElem.get(0),r.setResolution(e.videoWidth,e.videoHeight),r.isVideoAlreadyPlayed=!0):r.videoStats.stop()})),this.stopStreaming=function(){console.info("video: stopping streaming"),this.streaming.send({message:{request:"stop"}}),this.streaming.hangup(),this.cleanup()},this.cleanup=function(){console.info("video: cleanup .."),this.videoStats.stop()}}function VideoStats(e,n,t){this.streaming=null,this.bitrateElem=e,this.resolutionElem=n,this.remoteVideoElem=t,this.interval=null,this.setStreamingPluginHandle=function(e){this.streaming=e},this.isWorking=function(){return this.interval},this.hideElems=function(){this.bitrateElem.addClass("d-none"),this.resolutionElem.addClass("d-none")},this.showElems=function(){this.bitrateElem.removeClass("d-none"),this.resolutionElem.removeClass("d-none")},this.stop=function(){this.isWorking()&&(clearInterval(this.interval),this.hideElems(),console.debug("VideoStats: stopped"))},this._showCurrentResolution=function(){this.resolutionElem.text(this.remoteVideoElem.get(0).width+"x"+this.remoteVideoElem.get(0).height)},this.start=function(){var e;this.stop(),(e=this).interval=setInterval((function(){var n=e.streaming.getBitrate();e.bitrateElem.text(n);var t=e.remoteVideoElem.get(0).videoWidth,r=e.remoteVideoElem.get(0).videoHeight;t>0&&r>0&&e.resolutionElem.text(t+"x"+r),e.showElems()}),500),console.debug("VideoStats: started")}}function GestureBuilder(e,n){this.divGesture=e,this.remoteChat=n,this.swipeStartPosition=[0,0],this.swipeStartMillis=0,this.swipeInProcess=!1;let t=this;this.gestureStart=function(e,n){console.debug("gesture: starts on ",[e,n]),this.swipeInProcess=!0,this.swipeStartMillis=Date.now(),this.swipeStartPosition=[e,n]},this.gestureFinish=function(e,n){if(e=e>0?e:0,n=n>0?n:0,this.swipeInProcess){console.debug("gesture: ends on ",[e,n]);var t=Date.now()-this.swipeStartMillis,r=[e,n],o="";o=Math.abs(this.swipeStartPosition[0]-r[0])<2&&Math.abs(this.swipeStartPosition[1]-r[1])<2?`tap,${this.swipeStartPosition[0]},${this.swipeStartPosition[1]},${t}`:`swipe,${this.swipeStartPosition[0]},${this.swipeStartPosition[1]},${r[0]},${r[1]},${t}`,this.remoteChat.sendData(o),this.swipeInProcess=!1}},this.divGesture.on("mousedown",(function(e){$(e.target).css("cursor","pointer"),t.gestureStart(e.offsetX,e.offsetY),e.preventDefault()})).on("mouseup",(function(e){$(e.target).css("cursor","auto"),t.gestureFinish(e.offsetX,e.offsetY),e.preventDefault()})).on("mouseleave",(function(e){$(e.target).css("cursor","auto"),t.gestureFinish(e.offsetX,e.offsetY),e.preventDefault()}))}Janus.useDefaultDependencies=function(e){var n=e&&e.fetch||fetch,t=e&&e.Promise||Promise,r=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,n){return new r(e,n)},extension:e&&e.extension||defaultExtension,isArray:function(e){return Array.isArray(e)},webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,r){var o={method:r.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===r.verb&&(o.headers["Content-Type"]="application/json"),void 0!==r.withCredentials&&(o.credentials=!0===r.withCredentials?"include":r.withCredentials?r.withCredentials:"omit"),r.body&&(o.body=JSON.stringify(r.body));var a=n(e,o).catch((function(e){return t.reject({message:"Probably a network error, is the server down?",error:e})}));if(r.timeout){var s=new t((function(e,n){var t=setTimeout((function(){return clearTimeout(t),n({message:"Request timed out",timeout:r.timeout})}),r.timeout)}));a=t.race([a,s])}return a.then((function(e){return e.ok?typeof r.success==typeof Janus.noop?e.json().then((function(e){r.success(e)})).catch((function(n){return t.reject({message:"Failed to parse response body",error:n,response:e})})):void 0:t.reject({message:"API call failed",response:e})})).catch((function(e){typeof r.error==typeof Janus.noop&&r.error(e.message||"<< internal error >>",e)})),a}}},Janus.useOldDependencies=function(e){var n=e&&e.jQuery||jQuery,t=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,n){return new t(e,n)},isArray:function(e){return n.isArray(e)},extension:e&&e.extension||defaultExtension,webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,t){var r=void 0!==t.body?{contentType:"application/json",data:JSON.stringify(t.body)}:{},o=void 0!==t.withCredentials?{xhrFields:{withCredentials:t.withCredentials}}:{};return n.ajax(n.extend(r,o,{url:e,type:t.verb,cache:!1,dataType:"json",async:t.async,timeout:t.timeout,success:function(e){typeof t.success==typeof Janus.noop&&t.success(e)},error:function(e,n,r){typeof t.error==typeof Janus.noop&&t.error(n,r)}}))}}},Janus.noop=function(){},Janus.dataChanDefaultLabel="JanusDataChannel",Janus.endOfCandidates=null,Janus.stopAllTracks=function(e){try{var n=e.getTracks();for(var t of n)Janus.log(t),t&&t.stop()}catch(e){}},Janus.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:Janus.noop,Janus.initDone)e.callback();else{if("undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),Janus.trace=Janus.noop,Janus.debug=Janus.noop,Janus.vdebug=Janus.noop,Janus.log=Janus.noop,Janus.warn=Janus.noop,Janus.error=Janus.noop,!0===e.debug||"all"===e.debug)Janus.trace=console.trace.bind(console),Janus.debug=console.debug.bind(console),Janus.vdebug=console.debug.bind(console),Janus.log=console.log.bind(console),Janus.warn=console.warn.bind(console),Janus.error=console.error.bind(console);else if(Array.isArray(e.debug))for(var n of e.debug)switch(n){case"trace":Janus.trace=console.trace.bind(console);break;case"debug":Janus.debug=console.debug.bind(console);break;case"vdebug":Janus.vdebug=console.debug.bind(console);break;case"log":Janus.log=console.log.bind(console);break;case"warn":Janus.warn=console.warn.bind(console);break;case"error":Janus.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+n+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}Janus.log("Initializing library");var t=e.dependencies||Janus.useDefaultDependencies();Janus.isArray=t.isArray,Janus.webRTCAdapter=t.webRTCAdapter,Janus.httpAPICall=t.httpAPICall,Janus.newWebSocket=t.newWebSocket,Janus.extension=t.extension,Janus.extension.init(),Janus.listDevices=function(e,n){e="function"==typeof e?e:Janus.noop,null==n&&(n={audio:!0,video:!0}),Janus.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(n).then((function(n){navigator.mediaDevices.enumerateDevices().then((function(t){Janus.debug(t),e(t),Janus.stopAllTracks(n)}))})).catch((function(n){Janus.error(n),e([])})):(Janus.warn("navigator.mediaDevices unavailable"),e([]))},Janus.attachMediaStream=function(e,n){try{e.srcObject=n}catch(t){try{e.src=URL.createObjectURL(n)}catch(e){Janus.error("Error attaching stream to element")}}},Janus.reattachMediaStream=function(e,n){try{e.srcObject=n.srcObject}catch(t){try{e.src=n.src}catch(e){Janus.error("Error reattaching stream to element")}}};var r=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",o=window["on"+r];if(window.addEventListener(r,(function(e){for(var n in Janus.log("Closing window"),Janus.sessions)Janus.sessions[n]&&Janus.sessions[n].destroyOnUnload&&(Janus.log("Destroying session "+n),Janus.sessions[n].destroy({unload:!0,notifyDestroyed:!1}));o&&"function"==typeof o&&o()})),Janus.safariVp8=!1,"safari"===Janus.webRTCAdapter.browserDetails.browser&&Janus.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(var a of RTCRtpSender.getCapabilities("video").codecs)if(a&&a.mimeType&&"video/vp8"===a.mimeType.toLowerCase()){Janus.safariVp8=!0;break}Janus.safariVp8?Janus.log("This version of Safari supports VP8"):Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{var s=new RTCPeerConnection({});s.createOffer({offerToReceiveVideo:!0}).then((function(e){Janus.safariVp8=-1!==e.sdp.indexOf("VP8"),Janus.safariVp8?Janus.log("This version of Safari supports VP8"):Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),s.close(),s=null}))}if(Janus.unifiedPlan=!1,"firefox"===Janus.webRTCAdapter.browserDetails.browser&&Janus.webRTCAdapter.browserDetails.version>=59)Janus.unifiedPlan=!0;else if("chrome"===Janus.webRTCAdapter.browserDetails.browser&&Janus.webRTCAdapter.browserDetails.version>=72)Janus.unifiedPlan=!0;else if(window.RTCRtpTransceiver&&"currentDirection"in RTCRtpTransceiver.prototype){var i=new RTCPeerConnection;try{i.addTransceiver("audio"),Janus.unifiedPlan=!0}catch(e){}i.close()}else Janus.unifiedPlan=!1;Janus.initDone=!0,e.callback()}},Janus.isWebrtcSupported=function(){return!!window.RTCPeerConnection},Janus.isGetUserMediaAvailable=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},Janus.randomString=function(e){for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="",r=0;r<e;r++){var o=Math.floor(Math.random()*n.length);t+=n.substring(o,o+1)}return t},window.loader=new Loader($("#pageLoader")),$(document).ready((function(){var e=new UI;if(window.ui=e,!Janus.isWebrtcSupported())return e.showErrorModal("There is no WebRTC support in this browser. Please, try the newest version of Google Chrome or Mozilla Firefox","no_webrtc_support",(function(){window.location.reload()})),void console.error("No WebRTC support - no cartoons");var n=new RemoteChat($("#textroomChat"),$("#chat-form"),$("#textroomMessageInput"),$("#textroomSendButton")),t=new VideoStats($("#streamingCurrentBitrate"),$("#streamingCurrentResolution"),$("#streamingRemoteVideo")),r=new Loader($("#videoLoader")),o=new RemoteVideo($("#streamingRemoteVideo"),r,t),a=new Commands(n,o);n.setCommandsProcessor(a);new GestureBuilder($("#deviceGestures"),n),new SessionMonitoring(n);window.cheatCodes=new CheatCodes;new RemoteKeyboard(n),new RemoteClipboard(n);console.debug("actual Janus servers:",janusServers),console.debug("janus debug level:",janusDebugLevel),window.debugUtils=new DebugUtils(n),e.on("CheatCodes.onCheatEntered",(function(e){"needtodebug"===e&&window.debugUtils.enable()}));var s=null,i=null,d=null;e.initStart(),Janus.init({debug:janusDebugLevel,callback:function(){s=new Janus({server:janusServers,apisecret:apiSecret,success:function(){s.attach({plugin:"janus.plugin.textroom",opaqueId:textroomOpaqueId,success:function(t){i=t,console.info("textroom: plugin attached! ("+i.getPlugin()+", id="+i.getId()+")"),n.setUp(i),e.initTextroomReady()},error:function(e){console.error("textroom: error attaching plugin: ",e),bootbox.alert("   : "+e)},iceState:function(e){console.debug("textroom: ICE state changed to "+e)},webrtcState:function(e){console.debug("textroom: WebRTC PeerConnection is "+(e?"UP":"DOWN")+" now")},slowLink:function(n,t){e.showWarning("Network problems","Device management",null,null,2e3)},onmessage:function(n,t){console.debug("textroom: got a message ",n),n.error&&(console.error("textroom: onmessage got error",n),bootbox.alert(n.error)),t&&(console.debug("textroom: answering for SDP",t),i.createAnswer({jsep:t,media:{audio:!1,video:!1,data:!0},success:function(e){console.debug("textroom: success answering with SDP",e);i.send({message:{request:"ack"},jsep:e})},error:function(n){console.error("textroom: WebRTC error",n),e.showError(`'WebRTC error: ${JSON.stringify(n)}`,"webrtc_error")}}))},ondataopen:function(e){console.debug("textroom: DataChannel is available",e)},ondata:function(e){console.debug("textroom: got data from DataChannel",e);var t=JSON.parse(e),r=t.transaction,o=n.processTransactionAnswer(r,t);if(o)console.debug("textroom: done transaction with id",r,"and result",o);else{var a=t.textroom;"message"===a?n.processIncomingMessage(t.text,t.from,t.date,t.whisper):"announcement"===a?n.processAnnouncement(t.text,t.date):"join"===a?n.processJoin(t.username,t.display):"leave"===a?n.processLeave(t.username):"kicked"===a?n.processKick(t.username):"destroyed"===a&&n.processRoomDestroy(t.room)}},oncleanup:function(){console.info("textroom: got cleanup"),n.cleanup()}}),s.attach({plugin:"janus.plugin.streaming",opaqueId:streamingOpaqueId,success:function(n){d=n,console.info("streaming: plugin attached! ("+d.getPlugin()+", id="+d.getId()+")"),o.setStreamingPluginHandle(d),t.setStreamingPluginHandle(d),e.initStreamingReady()},error:function(n){console.error("streaming: error attaching plugin",n),e.showError(`'Streaming error: ${n}`,"streaming_error")},iceState:function(e){console.debug("streaming: ICE state changed to "+e)},webrtcState:function(e){console.debug("streaming: WebRTC PeerConnection is "+(e?"UP":"DOWN")+" now")},slowLink:function(n,t){e.showWarning("Network problems","Screen sharing",null,null,2e3)},onmessage:function(n,t){console.debug("streaming: got a message",n,t);var r=n.result;if(r)r.status?"starting"===r.status?$("#streamingStatus").text("Starting, please wait...").removeClass("d-none"):"started"===r.status?$("#streamingStatus").text("Started").removeClass("d-none"):"stopped"===r.status&&o.stopStreaming():n.streaming,e.connStreamingReady();else if(n.error)return console.error("streaming: onmessage error",n.error),e.connAbort(),void(455===n.error_code?e.showError(`Session ${o.mountpointId} does not exist`,"no_session"):(e.showError(n.error,"streaming_message_error"),o.stopStreaming()));if(t){console.debug("streaming: handling remote SDP",t);var a=-1!==t.sdp.indexOf("stereo=1");d.createAnswer({jsep:t,media:{audioSend:!1,videoSend:!1,data:!0},customizeSdp:function(e){a&&-1===e.sdp.indexOf("stereo=1")&&(e.sdp=e.sdp.replace("useinbandfec=1","useinbandfec=1;stereo=1"),console.debug("streaming: SDP customized",e))},success:function(e){console.debug("streaming: success answering with SDP",e);d.send({message:{request:"start"},jsep:e})},error:function(n){console.error("streaming: WebRTC error",n),e.showError(`'WebRTC error: ${JSON.stringify(n)}`,"webrtc_error")}})}},onremotestream:function(e){console.info("streaming: got remote stream",e),o.setStream(e)},oncleanup:function(){console.info("streaming: got cleanup"),o.cleanup()}})},error:function(n){e.showErrorModal(`Session error: ${n}`,"janus_session_error",(function(){window.location.reload()}),5)},destroyed:function(){e.sessionClosedRemotely("Session has been destroyed")}})}}),$("#login-form").on("submit",(function(t){var r=$("#input-session-id").val(),a=$("#input-pin").val();e.connStart(),o.startStreamMountpoint(r,a),n.startRoom(r,a),t.preventDefault()})),$("#btnBack").on("click",(function(e){n&&n.sendData("back")})),$("#btnHome").on("click",(function(e){n&&n.sendData("home")})),$("#btnRecents").on("click",(function(e){n&&n.sendData("recents")})),$("#btnNotifications").on("click",(function(e){n&&n.sendData("notifications")})),$("#btnDisconnect").on("click",(function(n){e.emit("Session.Disconnect")})),e.on("Session.Disconnect",(function(){o.stopStreaming(),n.leaveRoom(),e.disconnect()})),$("#debugClose").on("click",(function(e){window.debugUtils.disable()}))}));